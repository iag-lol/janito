<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combustible Lo Echevers</title>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome para √≠conos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #a0d2eb;
            /* Azul pastel */
            --secondary-color: #e6f2ff;
            /* Azul muy claro */
            --accent-color: #4b86b4;
            /* Azul oscuro para acentos */
            --text-color: #333;
            /* Texto oscuro */
            --light-text: #666;
            /* Texto gris para info secundaria */
            --success-color: #c8e6c9;
            /* Verde claro para status ok */
            --warning-color: #fff9c4;
            /* Amarillo claro para advertencias */
            --danger-color: #ffcdd2;
            /* Rojo claro para alertas */
            --white: #ffffff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--white);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            padding: 30px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center center;
            color: white;
            min-height: 180px;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(75, 134, 180, 0.65);
            /* Overlay azul semitransparente, ajustado para mejor visibilidad */
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 2rem;
            color: white;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            margin: 5px 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-actions button {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            transition: all 0.3s;
        }

        .header-actions button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* Contenedor principal del header */
        #main-header {
            position: relative;
            overflow: hidden;
            /* recorta lo que sobresalga */
            padding: 1.5rem 1.5rem;
            /* define altura seg√∫n contenido */
            color: white;
            text-align: center;
        }

        /* Imagen de fondo centrada verticalmente, ancho completo */
        #main-header .header-bg {
            position: absolute;
            top: 50%;
            /* punto medio vertical de la imagen */
            left: 0;
            /* ancla al borde izquierdo */
            width: 100%;
            /* cubre todo el ancho */
            height: auto;
            /* mantiene proporci√≥n */
            transform: translateY(-50%);
            /* centra verticalmente */
            z-index: 0;
            filter: brightness(0.6);
        }

        /* √Årea para subir archivos */
        .upload-section {
            display: flex;
            justify-content: flex-end;
            /* Alinea a la derecha */
            margin-bottom: 20px;
        }

        /* Contenedor de carga de archivos */
        .file-upload-container {
            background-color: var(--white);
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            width: 350px;
            /* M√°s ancho */
            min-height: 250px;
            /* Altura adecuada */
            padding: 25px 20px;
            /* Padding vertical m√°s delgado */
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: var(--box-shadow);
            margin-left: auto;
            /* Alinea a la derecha */
            margin-right: 0;
        }

        .file-upload-container.drag-over {
            background-color: var(--secondary-color);
            border-color: var(--accent-color);
        }

        .file-upload-container p {
            margin-bottom: 15px;
            color: var(--light-text);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-label:hover {
            background-color: #3a6d91;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--accent-color);
            display: none;
        }

        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            flex: 1 1 200px;
            min-width: 200px;
            text-align: center;
            border-top: 4px solid var(--primary-color);
        }

        .card.warning {
            border-top-color: #ffc107;
            /* Amarillo warning */
        }

        .card.success {
            border-top-color: #4caf50;
            /* Verde success */
        }

        .card h3 {
            font-size: 1rem;
            color: var(--light-text);
            margin-bottom: 10px;
        }

        .card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .card.warning .number {
            color: #e65100;
            /* Naranja oscuro */
        }

        .card.success .number {
            color: #2e7d32;
            /* Verde oscuro */
        }

        .card .percentage {
            font-size: 1rem;
            color: var(--light-text);
            margin-top: 5px;
        }

        .dashboard-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background-color: #3a6d91;
        }

        .btn i {
            font-size: 1.1rem;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }

        .btn-outline:hover {
            background-color: var(--secondary-color);
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
            max-width: 500px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 0.9rem;
        }

        .search-bar button {
            padding: 10px 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: var(--accent-color);
            color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.85rem;
            background-color: var(--white);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th,
        td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--primary-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr {
            height: 32px;
            /* Filas m√°s delgadas */
        }

        tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .date-time {
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: #856404;
        }

        .badge-success {
            background-color: var(--success-color);
            color: #155724;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: #721c24;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination button {
            padding: 6px 10px;
            background-color: var(--white);
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Opciones de paginaci√≥n */
        .pagination-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--white);
        }

        .show-all-btn {
            padding: 6px 12px;
            background-color: var(--white);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .show-all-btn:hover {
            background-color: var(--secondary-color);
        }

        .show-all-btn.active {
            background-color: var(--accent-color);
            color: white;
        }

        /* Estilos para los filtros */
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .filter-label {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-right: 5px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--white);
        }

        /* Estilos para el gr√°fico */
        .chart-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            margin-bottom: 25px;
            height: 280px;
            overflow: hidden;
            position: relative;
        }

        .chart-title {
            font-size: 1rem;
            color: var(--accent-color);
            margin-bottom: 10px;
            text-align: center;
        }

        #graficos-tab .chart-container {
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        #graficos-tab .chart-container canvas {
            flex-grow: 1;
            max-height: 250px;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px;
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Loader */
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid var(--secondary-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Estilos para PDF print */
        @media print {
            body * {
                visibility: hidden;
            }

            .printable-table,
            .printable-table * {
                visibility: visible;
            }

            .printable-table {
                position: absolute;
                left: 0;
                top: 0;
            }
        }

        .text-center {
            text-align: center;
        }

        /* Media queries para responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.2rem;
            }

            .card {
                min-width: calc(50% - 15px);
            }

            .dashboard-actions {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                margin-top: 10px;
            }

            .upload-section {
                justify-content: center;
            }

            .file-upload-container {
                width: 100%;
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3rem;
            }

            .card {
                min-width: 100%;
            }

            .summary-cards {
                flex-direction: column;
            }

            .tab {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }

        /* Estilos para los campos editables */
        .ubicacion-input {
            width: 90%;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
        }

        .estado-select {
            width: 90%;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: white;
            text-align: center;
            cursor: pointer;
        }

        .estado-select option[value="Operativo"] {
            color: #2e7d32;
            font-weight: 500;
        }

        .estado-select option[value="Panne"] {
            color: #c62828;
            font-weight: 500;
        }

        .estado-select option[value="Taller Externo"] {
            color: #f57f17;
            font-weight: 500;
        }

        .estado-select option:checked {
            font-weight: bold;
        }

        .estado-select[data-estado="Operativo"] {
            color: #2e7d32;
            border-color: #2e7d32;
        }

        .estado-select[data-estado="Panne"] {
            color: #c62828;
            border-color: #c62828;
        }

        .estado-select[data-estado="Taller Externo"] {
            color: #f57f17;
            border-color: #f57f17;
        }

        .ubicacion-input:focus,
        .estado-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(75, 134, 180, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <header id="main-header">
            <!-- Imagen de fondo -->
            <img src="img/header-fondo.jpeg" alt="Fondo Header" class="header-bg">
            <img src="/janito/img/header-fondo.jpeg" alt="Fondo Header" class="header-bg">

            <div class="header-content">
                <div>
                    <h1>Carga de Combustible - Janito ü´∞</h1>
                    <p>Flota Lo Echevers ‚Äì <span id="current-date"></span></p>
                    <p class="last-update">√öltima actualizaci√≥n: <span id="last-update-time"></span></p>
                </div>
                <div class="upload-section">
                    <div class="file-upload-container" id="file-upload-container">
                        <p><i class="fas fa-file-upload"></i> Arrastra o selecciona un archivo de carga de combustible
                            (.xlsx)</p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx, .xls">
                        <label for="file-input" class="file-label">Seleccionar archivo</label>
                        <div class="file-name" id="file-name"></div>
                    </div>
                </div>
            </div>
        </header>



        <div class="summary-cards">
            <div class="card">
                <h3>Total Buses</h3>
                <div class="number" id="total-buses">0</div>
                <div class="percentage">Flota completa</div>
            </div>
            <div class="card success">
                <h3>Con Carga</h3>
                <div class="number" id="buses-con-carga">0</div>
                <div class="percentage" id="porcentaje-cargados">0%</div>
            </div>
            <div class="card warning">
                <h3>Pendientes</h3>
                <div class="number" id="buses-sin-carga">0</div>
                <div class="percentage" id="porcentaje-pendientes">0%</div>
            </div>
            <div class="card">
                <h3>Cantidad Promedio</h3>
                <div class="number" id="promedio-litros">0 L</div>
                <div class="percentage">litros por bus</div>
            </div>
        </div>

        <!-- Gr√°fico de carga por hora -->
        <div class="chart-container">
            <h3 class="chart-title">Distribuci√≥n de Cargas por Hora</h3>
            <canvas id="hourly-chart"></canvas>
        </div>

        <div class="dashboard-actions">
            <button class="btn" id="download-excel">
                <i class="fas fa-file-excel"></i> Descargar Excel
            </button>
            <button class="btn" id="download-pdf">
                <i class="fas fa-file-pdf"></i> Descargar PDF Tabla
            </button>
            <button class="btn btn-outline" id="print-report">
                <i class="fas fa-print"></i> Imprimir reporte
            </button>
        </div>

        <!-- Filtros -->
        <div class="filters-container">
            <span class="filter-label">Filtrar por:</span>
            <select id="filter-modelo" class="filter-select">
                <option value="">Todos los modelos</option>
            </select>
            <select id="filter-tipo" class="filter-select">
                <option value="">Todos los tipos</option>
            </select>
            <select id="filter-terminal" class="filter-select">
                <option value="">Todos los terminales</option>
            </select>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Buscar por n√∫mero interno o patente...">
            <button id="search-button"><i class="fas fa-search"></i></button>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="pendientes">Buses Pendientes</div>
            <div class="tab" data-tab="cargados">Buses con Carga</div>
            <div class="tab" data-tab="graficos">Gr√°ficos</div>
        </div>

        <div class="tab-content active" id="pendientes-tab">
            <h2>Buses Pendientes de Carga</h2>

            <div class="pagination-options">
                <div class="rows-per-page">
                    <label for="pendientes-per-page">Filas por p√°gina:</label>
                    <select id="pendientes-per-page">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="show-all-pendientes" class="show-all-btn">Mostrar todos</button>
            </div>

            <div class="table-container" id="pendientes-table-container">
                <table id="buses-pendientes-table">
                    <thead>
                        <tr>
                            <th>N¬∞ Interno</th>
                            <th>Patente</th>
                            <th>Modelo</th>
                            <th>Tipo</th>
                            <th>Ubicaci√≥n</th>
                            <th>Estado</th>
                            <th>Estado Carga</th>
                        </tr>
                    </thead>
                    <tbody id="buses-pendientes-body">
                        <tr>
                            <td colspan="7" class="text-center">No hay datos disponibles. Por favor, suba un archivo de
                                carga.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pendientes-pagination">
                <!-- Paginaci√≥n generada din√°micamente -->
            </div>
        </div>

        <div class="tab-content" id="cargados-tab">
            <h2>Buses con Carga Completada</h2>

            <div class="pagination-options">
                <div class="rows-per-page">
                    <label for="cargados-per-page">Filas por p√°gina:</label>
                    <select id="cargados-per-page">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="show-all-cargados" class="show-all-btn">Mostrar todos</button>
            </div>

            <div class="table-container" id="cargados-table-container">
                <table id="buses-cargados-table">
                    <thead>
                        <tr>
                            <th>N¬∞ Interno</th>
                            <th>Patente</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Litros</th>
                            <th>Terminal</th>
                            <th>Modelo</th>
                        </tr>
                    </thead>
                    <tbody id="buses-cargados-body">
                        <tr>
                            <td colspan="7" class="text-center">No hay datos disponibles. Por favor, suba un archivo de
                                carga.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="cargados-pagination">
                <!-- Paginaci√≥n generada din√°micamente -->
            </div>
        </div>

        <div class="tab-content" id="graficos-tab">
            <h2>An√°lisis Gr√°fico</h2>

            <div class="chart-container">
                <h3 class="chart-title">Distribuci√≥n de Cargas por Modelo</h3>
                <canvas id="model-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Distribuci√≥n de Cargas por Tipo</h3>
                <canvas id="type-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Promedio de Litros por Modelo</h3>
                <canvas id="liters-chart"></canvas>
            </div>
        </div>

        <div class="loader" id="loader"></div>

        <div class="footer">
            <p>Sistema de An√°lisis de Carga de Combustible | Lo Echevers &copy; 2025</p>
        </div>
    </div>

    <script>
        // Variables para almacenar los datos
        let busesCargados = [];
        let busesSinCarga = [];
        let flotaCompleta = [];

        // Variables para la flota
        const datosFlota = [
            { numInterno: 1887, patente: "LXWP65", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1908, patente: "PFVG93", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1747, patente: "PFYC59", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1750, patente: "PFYC62", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1751, patente: "PFYC63", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1760, patente: "PFYC82", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1763, patente: "PFZK85", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1764, patente: "PFZK87", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1765, patente: "PFZK88", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1766, patente: "PGBF42", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1767, patente: "PGBY47", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1768, patente: "PGBY52", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1769, patente: "PGBY55", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1770, patente: "PGBY56", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1771, patente: "PGBY61", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1772, patente: "PGBY74", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1773, patente: "PGBY82", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1775, patente: "PGBY84", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1776, patente: "PGBY85", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1777, patente: "PGBY90", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1778, patente: "PGBY91", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1779, patente: "PGBY92", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1780, patente: "PGBZ15", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1783, patente: "PGLD59", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1784, patente: "PGLD60", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1785, patente: "PGLD62", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1786, patente: "PGLD63", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1787, patente: "PGLD68", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1788, patente: "PGLD72", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1789, patente: "PGLD82", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 1790, patente: "PGTV13", modelo: "SCANIA", tipo: "ARTICULADO" },
            { numInterno: 933, patente: "SHCY14", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1477, patente: "SHXG39", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1478, patente: "SHXG41", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1479, patente: "SHXG43", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1480, patente: "SHXG44", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1481, patente: "SJPC17", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1482, patente: "SJPC22", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1483, patente: "SJPC23", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1484, patente: "SJPC24", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1485, patente: "SJPC25", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1486, patente: "SJPC28", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1805, patente: "SJPC29", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1487, patente: "SJPD76", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1488, patente: "SJPD77", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1489, patente: "SJPD78", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1490, patente: "SJPD85", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1491, patente: "SKPH69", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1492, patente: "SKPH79", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1493, patente: "SKPJ45", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1494, patente: "SKPJ46", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1495, patente: "SKPJ48", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1496, patente: "SKPJ49", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1497, patente: "SKPJ53", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1498, patente: "SKPJ54", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1499, patente: "SKPK17", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1500, patente: "SKPK59", modelo: "VOLVO", tipo: "ARTICULADO" },
            { numInterno: 1501, patente: "SKPK60", modelo: "VOLVO", tipo: "ARTICULADO" }
        ];

        // Variables para la paginaci√≥n
        let pendientesItemsPerPage = 10;
        let cargadosItemsPerPage = 10;
        let currentPendientesPage = 1;
        let currentCargadosPage = 1;
        let showAllPendientes = false;
        let showAllCargados = false;

        // Arrays filtrados para b√∫squedas
        let filteredBusesSinCarga = [];
        let filteredBusesCargados = [];

        // Variables para los gr√°ficos
        let hourlyChart = null;
        let modelChart = null;
        let typeChart = null;
        let litersChart = null;

        // Inicializar la flota completa
        function inicializarFlota() {
            console.log("Inicializando flota...");
            flotaCompleta = [...datosFlota];
            busesSinCarga = [...flotaCompleta];  // Inicialmente, todos los buses est√°n sin carga
            filteredBusesSinCarga = [...busesSinCarga];
            filteredBusesCargados = [];
            busesCargados = [];

            // Cargar el estado guardado
            cargarEstadoBuses();

            // Inicializar los selectores de filtro
            actualizarFiltros();

            // Actualizar el dashboard
            updateDashboard();

            console.log(`Flota inicializada: ${flotaCompleta.length} buses en total`);
        }

        // Funci√≥n para procesar el archivo de carga
        function procesarArchivoCarga(archivo) {
            console.log("Procesando archivo:", archivo.name);
            const loader = document.getElementById('loader');
            if (loader) loader.style.display = 'block';

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    console.log("Archivo le√≠do correctamente");

                    // Procesar el archivo Excel
                    const workbook = XLSX.read(data, { cellDates: true });
                    console.log("Hojas en el archivo:", workbook.SheetNames);

                    // Obtener la primera hoja
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

                    // Intentar diferentes rangos para encontrar los encabezados
                    let jsonData;
                    try {
                        // Primero intentamos con encabezados en la tercera fila (√≠ndice 2)
                        jsonData = XLSX.utils.sheet_to_json(firstSheet, { range: 2 });
                        console.log("Procesando con encabezados en fila 3");

                        // Si no hay datos o los encabezados no son los esperados, probar con la segunda fila
                        if (jsonData.length === 0 || !jsonData[0]['N√∫mero interno']) {
                            jsonData = XLSX.utils.sheet_to_json(firstSheet, { range: 1 });
                            console.log("Procesando con encabezados en fila 2");
                        }

                        // Si a√∫n no hay datos, probar con la primera fila
                        if (jsonData.length === 0 || !jsonData[0]['N√∫mero interno']) {
                            jsonData = XLSX.utils.sheet_to_json(firstSheet, { range: 0 });
                            console.log("Procesando con encabezados en fila 1");
                        }

                        // Si sigue sin haber datos, probar con conversi√≥n directa sin encabezados
                        if (jsonData.length === 0) {
                            // Leer sin encabezados y asignar nombres de columna manualmente
                            const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                            console.log("Procesando en modo raw:", rawData.length, "filas");

                            // Buscar la fila que podr√≠a contener los encabezados
                            let headerIndex = -1;
                            for (let i = 0; i < Math.min(10, rawData.length); i++) {
                                const row = rawData[i];
                                if (row && row.length > 0) {
                                    // Buscar palabras clave en los encabezados
                                    const rowStr = row.join(' ').toLowerCase();
                                    if (rowStr.includes('interno') || rowStr.includes('patente') || rowStr.includes('combustible')) {
                                        headerIndex = i;
                                        break;
                                    }
                                }
                            }

                            if (headerIndex !== -1) {
                                // Crear un nuevo array con los encabezados encontrados
                                const headers = rawData[headerIndex];
                                jsonData = [];

                                // Procesar las filas de datos
                                for (let i = headerIndex + 1; i < rawData.length; i++) {
                                    const row = rawData[i];
                                    if (row && row.length > 0) {
                                        const dataObj = {};
                                        for (let j = 0; j < headers.length; j++) {
                                            if (headers[j]) dataObj[headers[j]] = row[j];
                                        }
                                        jsonData.push(dataObj);
                                    }
                                }
                                console.log("Datos procesados en modo manual:", jsonData.length);
                            }
                        }
                    } catch (error) {
                        console.error("Error al procesar el archivo con encabezados:", error);
                        // √öltima opci√≥n: leer como matriz y hacer una conversi√≥n manual
                        const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        // Buscar la fila que parece contener datos de buses
                        for (let i = 0; i < rawData.length; i++) {
                            const row = rawData[i];
                            // Buscar si hay alg√∫n n√∫mero que podr√≠a ser un bus interno
                            if (row && row.some(cell => typeof cell === 'number' && cell > 500 && cell < 3000)) {
                                console.log("Posible fila de datos encontrada en √≠ndice:", i);
                                break;
                            }
                        }

                        console.log("Datos raw:", rawData.slice(0, 5));
                        throw new Error("No se pudieron procesar los datos autom√°ticamente");
                    }

                    // Verificar que se encontraron datos
                    if (!jsonData || jsonData.length === 0) {
                        throw new Error("No se encontraron datos v√°lidos en el archivo");
                    }

                    console.log("Datos encontrados:", jsonData.length, "registros");
                    console.log("Muestra:", jsonData.slice(0, 2));

                    // Procesar los datos
                    procesarDatosCarga(jsonData);

                    // Ocultar el loader
                    if (loader) loader.style.display = 'none';

                    // Mostrar mensaje de √©xito
                    alert('Archivo procesado correctamente: ' + jsonData.length + ' registros');

                } catch (error) {
                    console.error('Error al procesar el archivo:', error);
                    if (loader) loader.style.display = 'none';
                    alert('Error al procesar el archivo: ' + error.message + '\nVerifica que sea un archivo Excel v√°lido con el formato correcto.');
                }
            };

            reader.onerror = function (error) {
                console.error('Error al leer el archivo:', error);
                if (loader) loader.style.display = 'none';
                alert('Error al leer el archivo: ' + error.message);
            };

            reader.readAsArrayBuffer(archivo);
        }

        // Funci√≥n para procesar los datos de carga
        function procesarDatosCarga(datos) {
            console.log("Iniciando procesamiento de datos de carga...");

            // Limpiar datos previos
            busesCargados = [];

            // Identificar los nombres de columnas
            const primeraFila = datos[0];
            let campoNumeroInterno = null;
            let campoPatente = null;
            let campoFecha = null;
            let campoHora = null;
            let campoLitros = null;
            let campoTerminal = null;
            let campoTipo = null;
            let campoModelo = null;

            // Buscar campos equivalentes
            for (const campo in primeraFila) {
                const campoLC = campo.toLowerCase();
                if (campoLC.includes('interno') || campoLC.includes('n√∫mero')) {
                    campoNumeroInterno = campo;
                } else if (campoLC.includes('patente') || campoLC.includes('ppu')) {
                    campoPatente = campo;
                } else if (campoLC.includes('fecha')) {
                    campoFecha = campo;
                } else if (campoLC.includes('hora')) {
                    campoHora = campo;
                } else if (campoLC.includes('litros') || campoLC.includes('cantidad')) {
                    campoLitros = campo;
                } else if (campoLC.includes('terminal')) {
                    campoTerminal = campo;
                } else if (campoLC.includes('tipo')) {
                    campoTipo = campo;
                } else if (campoLC.includes('modelo') || campoLC.includes('chasis')) {
                    campoModelo = campo;
                }
            }

            console.log("Campos identificados:", {
                numeroInterno: campoNumeroInterno,
                patente: campoPatente,
                fecha: campoFecha,
                hora: campoHora,
                litros: campoLitros,
                terminal: campoTerminal,
                tipo: campoTipo,
                modelo: campoModelo
            });

            // Verificar que al menos tenemos los campos esenciales
            if (!campoNumeroInterno || !campoPatente) {
                throw new Error("No se encontraron las columnas necesarias en el archivo (N√∫mero interno, Patente)");
            }

            // Procesar cada registro
            let registrosValidos = 0;

            datos.forEach((item, index) => {
                // Obtener los valores de los campos
                const numInterno = item[campoNumeroInterno];
                const patente = item[campoPatente];

                // Verificar que tenemos los campos obligatorios
                if (numInterno && patente) {
                    // Convertir fecha y hora
                    let fecha, hora;

                    try {
                        // Procesar fecha
                        if (campoFecha && item[campoFecha]) {
                            // Verificar si es un string o un objeto Date
                            if (item[campoFecha] instanceof Date) {
                                fecha = item[campoFecha];
                            } else if (typeof item[campoFecha] === 'string') {
                                // Intentar parsear como fecha
                                fecha = new Date(item[campoFecha]);
                            } else {
                                // N√∫mero (fecha de Excel)
                                fecha = new Date(item[campoFecha]);
                            }
                        } else {
                            fecha = new Date();
                        }

                        // Procesar hora
                        if (campoHora && item[campoHora]) {
                            if (item[campoHora] instanceof Date) {
                                hora = item[campoHora];
                            } else if (typeof item[campoHora] === 'string') {
                                // Procesar hora como string
                                hora = new Date('1970-01-01T' + item[campoHora]);
                            } else {
                                // N√∫mero (hora de Excel)
                                hora = new Date(item[campoHora]);
                            }
                        } else {
                            hora = new Date();
                        }
                    } catch (error) {
                        console.warn(`Error al procesar fecha/hora en registro ${index}:`, error);
                        fecha = new Date();
                        hora = new Date();
                    }

                    // Crear objeto de bus cargado
                    const busCargado = {
                        numInterno: parseInt(numInterno) || numInterno,
                        patente: patente.toString(),
                        fecha: fecha instanceof Date ? fecha.toLocaleDateString('es-CL') : 'N/A',
                        hora: hora instanceof Date ? hora.toLocaleTimeString('es-CL') : 'N/A',
                        litros: campoLitros ? (parseInt(item[campoLitros]) || 0) : 0,
                        terminal: campoTerminal && item[campoTerminal] ? item[campoTerminal].toString() : 'N/A',
                        tipo: campoTipo && item[campoTipo] ? item[campoTipo].toString() : 'N/A',
                        modelo: campoModelo && item[campoModelo] ? item[campoModelo].toString() : 'N/A'
                    };

                    busesCargados.push(busCargado);
                    registrosValidos++;
                }
            });

            console.log(`Se procesaron ${registrosValidos} registros v√°lidos de ${datos.length} totales`);

            // Si no se encontraron registros v√°lidos, mostrar un error
            if (registrosValidos === 0) {
                throw new Error("No se encontraron registros v√°lidos en el archivo");
            }

            // Actualizar buses sin carga
            actualizarBusesSinCarga();

            // Actualizar filtros
            actualizarFiltros();

            // Actualizar gr√°ficos
            actualizarGraficos();

            // Actualizar dashboard
            filteredBusesCargados = [...busesCargados];
            updateDashboard();
        }

        // Funci√≥n para actualizar los buses sin carga
        function actualizarBusesSinCarga() {
            console.log("Actualizando buses sin carga...");

            // Obtener los n√∫meros internos de los buses con carga
            const busesConCarga = new Set();
            busesCargados.forEach(bus => {
                // Asegurar que sea un n√∫mero
                let numInterno = bus.numInterno;
                if (typeof numInterno === 'string') {
                    numInterno = parseInt(numInterno);
                }
                if (!isNaN(numInterno)) {
                    busesConCarga.add(numInterno);
                }
            });

            console.log("Buses con carga:", busesConCarga.size);

            // Filtrar la flota para obtener los buses sin carga
            busesSinCarga = flotaCompleta.filter(bus => {
                const numInterno = parseInt(bus.numInterno);
                return !busesConCarga.has(numInterno);
            });

            filteredBusesSinCarga = [...busesSinCarga];

            console.log("Buses sin carga:", busesSinCarga.length, "de", flotaCompleta.length);
        }

        // Funci√≥n para actualizar los filtros selectores
        function actualizarFiltros() {
            console.log("Actualizando filtros...");

            // Obtener modelos √∫nicos
            const modelos = new Set();
            flotaCompleta.forEach(bus => {
                if (bus.modelo) modelos.add(bus.modelo);
            });
            busesCargados.forEach(bus => {
                if (bus.modelo) modelos.add(bus.modelo);
            });

            // Obtener tipos √∫nicos
            const tipos = new Set();
            flotaCompleta.forEach(bus => {
                if (bus.tipo) tipos.add(bus.tipo);
            });
            busesCargados.forEach(bus => {
                if (bus.tipo) tipos.add(bus.tipo);
            });

            // Obtener terminales √∫nicos
            const terminales = new Set();
            busesCargados.forEach(bus => {
                if (bus.terminal) terminales.add(bus.terminal);
            });

            // Actualizar selector de modelos
            const modeloSelector = document.getElementById('filter-modelo');
            if (modeloSelector) {
                modeloSelector.innerHTML = '<option value="">Todos los modelos</option>';
                modelos.forEach(modelo => {
                    if (modelo) {
                        const option = document.createElement('option');
                        option.value = modelo;
                        option.textContent = modelo;
                        modeloSelector.appendChild(option);
                    }
                });
            }

            // Actualizar selector de tipos
            const tipoSelector = document.getElementById('filter-tipo');
            if (tipoSelector) {
                tipoSelector.innerHTML = '<option value="">Todos los tipos</option>';
                tipos.forEach(tipo => {
                    if (tipo) {
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = tipo;
                        tipoSelector.appendChild(option);
                    }
                });
            }

            // Actualizar selector de terminales
            const terminalSelector = document.getElementById('filter-terminal');
            if (terminalSelector) {
                terminalSelector.innerHTML = '<option value="">Todos los terminales</option>';
                terminales.forEach(terminal => {
                    if (terminal) {
                        const option = document.createElement('option');
                        option.value = terminal;
                        option.textContent = terminal;
                        terminalSelector.appendChild(option);
                    }
                });
            }

            console.log("Filtros actualizados:", {
                modelos: modelos.size,
                tipos: tipos.size,
                terminales: terminales.size
            });
        }

        // Funci√≥n para actualizar los gr√°ficos
        function actualizarGraficos() {
            console.log("Actualizando gr√°ficos...");

            // Verificar si hay datos de carga
            if (busesCargados.length === 0) {
                console.log("No hay datos de carga para generar gr√°ficos");
                return;
            }

            actualizarGraficoHorario();
            actualizarGraficoModelo();
            actualizarGraficoTipo();
            actualizarGraficoLitros();

            console.log("Gr√°ficos actualizados");
        }

        // Funci√≥n para actualizar el gr√°fico horario
        function actualizarGraficoHorario() {
            // Agrupar por hora
            const horasCarga = {};

            // Verificar que tenemos canvas para el gr√°fico
            const canvas = document.getElementById('hourly-chart');
            if (!canvas) {
                console.warn("No se encontr√≥ el canvas para el gr√°fico horario");
                return;
            }

            busesCargados.forEach(bus => {
                let hora = "00";

                // Intentar extraer la hora del formato
                if (bus.hora && typeof bus.hora === 'string') {
                    const matches = bus.hora.match(/(\d{1,2}):/);
                    if (matches && matches[1]) {
                        hora = matches[1].padStart(2, '0'); // Asegurar formato de 2 d√≠gitos
                    }
                }

                horasCarga[hora] = (horasCarga[hora] || 0) + 1;
            });

            // Ordenar las horas
            const horas = Object.keys(horasCarga).sort((a, b) => parseInt(a) - parseInt(b));
            const cantidades = horas.map(hora => horasCarga[hora]);

            // Formatear las horas para mejor visualizaci√≥n
            const horasFormateadas = horas.map(hora => `${hora}:00 hrs`);

            // Obtener el contexto 2D del canvas
            const ctx = canvas.getContext('2d');

            // Crear o actualizar el gr√°fico
            if (hourlyChart) {
                hourlyChart.data.labels = horasFormateadas;
                hourlyChart.data.datasets[0].data = cantidades;
                hourlyChart.update();
            } else {
                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: horasFormateadas,
                        datasets: [{
                            label: 'Cantidad de buses cargados',
                            data: cantidades,
                            backgroundColor: 'rgba(75, 134, 180, 0.7)', // Azul
                            borderColor: 'rgba(75, 134, 180, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            title: {
                                display: true,
                                text: 'Distribuci√≥n de cargas por hora del d√≠a'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de buses'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hora del d√≠a'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funci√≥n para actualizar el gr√°fico por modelo
        function actualizarGraficoModelo() {
            // Verificar que tenemos canvas para el gr√°fico
            const canvas = document.getElementById('model-chart');
            if (!canvas) {
                console.warn("No se encontr√≥ el canvas para el gr√°fico de modelo");
                return;
            }

            // Agrupar por modelo
            const modelosCarga = {};
            busesCargados.forEach(bus => {
                const modelo = bus.modelo || 'No especificado';
                modelosCarga[modelo] = (modelosCarga[modelo] || 0) + 1;
            });

            // Preparar datos para el gr√°fico
            const modelos = Object.keys(modelosCarga);
            const cantidades = modelos.map(modelo => modelosCarga[modelo]);

            // Colores para el gr√°fico de torta
            const colores = [
                'rgba(75, 134, 180, 0.7)',   // Azul
                'rgba(255, 99, 132, 0.7)',   // Rosa
                'rgba(255, 205, 86, 0.7)',   // Amarillo
                'rgba(54, 162, 235, 0.7)',   // Azul claro
                'rgba(153, 102, 255, 0.7)',  // P√∫rpura
                'rgba(255, 159, 64, 0.7)'    // Naranja
            ];

            // Asegurar que tenemos suficientes colores
            while (colores.length < modelos.length) {
                colores.push(...colores);
            }

            // Obtener el contexto 2D del canvas
            const ctx = canvas.getContext('2d');

            // Crear o actualizar el gr√°fico
            if (modelChart) {
                modelChart.data.labels = modelos;
                modelChart.data.datasets[0].data = cantidades;
                modelChart.update();
            } else {
                modelChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: modelos,
                        datasets: [{
                            data: cantidades,
                            backgroundColor: colores.slice(0, modelos.length),
                            borderColor: colores.slice(0, modelos.length).map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuci√≥n por Modelo',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funci√≥n para actualizar el gr√°fico por tipo
        function actualizarGraficoTipo() {
            // Verificar que tenemos canvas para el gr√°fico
            const canvas = document.getElementById('type-chart');
            if (!canvas) {
                console.warn("No se encontr√≥ el canvas para el gr√°fico de tipo");
                return;
            }

            // Agrupar por tipo
            const tiposCarga = {};
            busesCargados.forEach(bus => {
                const tipo = bus.tipo || 'No especificado';
                tiposCarga[tipo] = (tiposCarga[tipo] || 0) + 1;
            });

            // Preparar datos para el gr√°fico
            const tipos = Object.keys(tiposCarga);
            const cantidades = tipos.map(tipo => tiposCarga[tipo]);

            // Colores para el gr√°fico de dona
            const colores = [
                'rgba(75, 134, 180, 0.7)',   // Azul
                'rgba(255, 99, 132, 0.7)',   // Rosa
                'rgba(255, 205, 86, 0.7)',   // Amarillo
                'rgba(54, 162, 235, 0.7)'    // Azul claro
            ];

            // Asegurar que tenemos suficientes colores
            while (colores.length < tipos.length) {
                colores.push(...colores);
            }

            // Obtener el contexto 2D del canvas
            const ctx = canvas.getContext('2d');

            // Crear o actualizar el gr√°fico
            if (typeChart) {
                typeChart.data.labels = tipos;
                typeChart.data.datasets[0].data = cantidades;
                typeChart.update();
            } else {
                typeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: tipos,
                        datasets: [{
                            data: cantidades,
                            backgroundColor: colores.slice(0, tipos.length),
                            borderColor: colores.slice(0, tipos.length).map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuci√≥n por Tipo',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funci√≥n para actualizar el gr√°fico de promedio de litros por modelo
        function actualizarGraficoLitros() {
            // Verificar que tenemos canvas para el gr√°fico
            const canvas = document.getElementById('liters-chart');
            if (!canvas) {
                console.warn("No se encontr√≥ el canvas para el gr√°fico de litros");
                return;
            }

            // Agrupar por modelo
            const litrosPorModelo = {};
            const conteoModelos = {};

            busesCargados.forEach(bus => {
                const modelo = bus.modelo || 'No especificado';
                const litros = parseInt(bus.litros) || 0;

                if (!litrosPorModelo[modelo]) {
                    litrosPorModelo[modelo] = 0;
                    conteoModelos[modelo] = 0;
                }

                litrosPorModelo[modelo] += litros;
                conteoModelos[modelo]++;
            });

            // Calcular promedios
            const modelos = Object.keys(litrosPorModelo);
            const promedios = modelos.map(modelo => {
                if (conteoModelos[modelo] === 0) return 0;
                return Math.round(litrosPorModelo[modelo] / conteoModelos[modelo]);
            });

            // Obtener el contexto 2D del canvas
            const ctx = canvas.getContext('2d');

            // Crear o actualizar el gr√°fico
            if (litersChart) {
                litersChart.data.labels = modelos;
                litersChart.data.datasets[0].data = promedios;
                litersChart.update();
            } else {
                litersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: modelos,
                        datasets: [{
                            label: 'Promedio de litros',
                            data: promedios,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)', // Verde-azulado
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Promedio de Litros por Modelo',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Litros promedio'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Modelo'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Funci√≥n para aplicar filtros
        function aplicarFiltros() {
            console.log("Aplicando filtros...");

            const modelo = document.getElementById('filter-modelo')?.value || '';
            const tipo = document.getElementById('filter-tipo')?.value || '';
            const terminal = document.getElementById('filter-terminal')?.value || '';
            const searchTerm = document.getElementById('search-input')?.value?.toLowerCase() || '';

            console.log("Filtros aplicados:", { modelo, tipo, terminal, searchTerm });

            // Filtrar buses sin carga
            filteredBusesSinCarga = busesSinCarga.filter(bus => {
                const coincideModelo = !modelo || (bus.modelo && bus.modelo.toString() === modelo);
                const coincideTipo = !tipo || (bus.tipo && bus.tipo.toString() === tipo);
                const coincideTermino = !searchTerm ||
                    (bus.numInterno && bus.numInterno.toString().includes(searchTerm)) ||
                    (bus.patente && bus.patente.toString().toLowerCase().includes(searchTerm));

                return coincideModelo && coincideTipo && coincideTermino;
            });

            // Filtrar buses con carga
            filteredBusesCargados = busesCargados.filter(bus => {
                const coincideModelo = !modelo || (bus.modelo && bus.modelo.toString() === modelo);
                const coincideTipo = !tipo || (bus.tipo && bus.tipo.toString() === tipo);
                const coincideTerminal = !terminal || (bus.terminal && bus.terminal.toString() === terminal);
                const coincideTermino = !searchTerm ||
                    (bus.numInterno && bus.numInterno.toString().includes(searchTerm)) ||
                    (bus.patente && bus.patente.toString().toLowerCase().includes(searchTerm));

                return coincideModelo && coincideTipo && coincideTerminal && coincideTermino;
            });

            // Resetear paginaci√≥n
            currentPendientesPage = 1;
            currentCargadosPage = 1;

            // Actualizar tablas
            updatePendientesTable();
            updateCargadosTable();

            console.log("Resultados filtrados:", {
                pendientes: filteredBusesSinCarga.length,
                cargados: filteredBusesCargados.length
            });
        }

        // Funci√≥n para actualizar el dashboard con los datos
        function updateDashboard() {
            console.log("Actualizando dashboard...");

            const totalBuses = flotaCompleta.length;
            const porcentajeCargados = Math.round((busesCargados.length / totalBuses) * 100) || 0;
            const porcentajePendientes = 100 - porcentajeCargados;

            // Calcular promedio de litros
            let promedioLitros = 0;
            if (busesCargados.length > 0) {
                const totalLitros = busesCargados.reduce((sum, bus) => sum + (parseInt(bus.litros) || 0), 0);
                promedioLitros = Math.round(totalLitros / busesCargados.length);
            }

            // Actualizar las tarjetas de resumen
            document.getElementById('total-buses').textContent = totalBuses;
            document.getElementById('buses-con-carga').textContent = busesCargados.length;
            document.getElementById('buses-sin-carga').textContent = busesSinCarga.length;
            document.getElementById('porcentaje-cargados').textContent = `${porcentajeCargados}%`;
            document.getElementById('porcentaje-pendientes').textContent = `${porcentajePendientes}%`;
            document.getElementById('promedio-litros').textContent = `${promedioLitros} L`;

            // Actualizar fecha y hora
            document.getElementById('current-date').textContent = formatCurrentDate();
            document.getElementById('last-update-time').textContent = formatCurrentTime();

            // Actualizar las tablas
            updatePendientesTable();
            updateCargadosTable();

            console.log("Dashboard actualizado");
        }

        // Funci√≥n para actualizar la tabla de buses pendientes
        function updatePendientesTable() {
            console.log("Actualizando tabla de buses pendientes...");

            const table = document.getElementById('buses-pendientes-body');
            if (!table) {
                console.warn("No se encontr√≥ la tabla de buses pendientes");
                return;
            }

            table.innerHTML = '';

            if (filteredBusesSinCarga.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No hay buses pendientes de carga o no se ha subido un archivo de carga.</td>';
                table.appendChild(row);

                const paginacion = document.getElementById('pendientes-pagination');
                if (paginacion) paginacion.innerHTML = '';

                return;
            }

            const effectiveItemsPerPage = showAllPendientes ? filteredBusesSinCarga.length : pendientesItemsPerPage;
            const startIndex = (currentPendientesPage - 1) * effectiveItemsPerPage;
            const endIndex = Math.min(startIndex + effectiveItemsPerPage, filteredBusesSinCarga.length);

            for (let i = startIndex; i < endIndex; i++) {
                const bus = filteredBusesSinCarga[i];
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td class="cell-highlight">${bus.numInterno}</td>
                    <td>${bus.patente}</td>
                    <td>${bus.modelo}</td>
                    <td>${bus.tipo}</td>
                    <td>
                        <input type="text" class="ubicacion-input" value="${bus.ubicacion || ''}" 
                            data-bus-id="${bus.numInterno}" placeholder="Ingrese ubicaci√≥n">
                    </td>
                    <td>
                        <select class="estado-select" data-bus-id="${bus.numInterno}" data-estado="${bus.estado || 'Operativo'}">
                            <option value="Operativo" ${bus.estado === 'Operativo' ? 'selected' : ''}>Operativo</option>
                            <option value="Panne" ${bus.estado === 'Panne' ? 'selected' : ''}>Panne</option>
                            <option value="Taller Externo" ${bus.estado === 'Taller Externo' ? 'selected' : ''}>Taller Externo</option>
                        </select>
                    </td>
                    <td><span class="badge badge-warning">Pendiente</span></td>
                `;

                // Agregar event listeners para los campos editables
                const ubicacionInput = row.querySelector('.ubicacion-input');
                const estadoSelect = row.querySelector('.estado-select');

                ubicacionInput.addEventListener('change', function() {
                    const busId = this.getAttribute('data-bus-id');
                    const bus = busesSinCarga.find(b => b.numInterno.toString() === busId);
                    if (bus) {
                        bus.ubicacion = this.value;
                        // Guardar en localStorage
                        guardarEstadoBuses();
                    }
                });

                estadoSelect.addEventListener('change', function() {
                    const busId = this.getAttribute('data-bus-id');
                    const bus = busesSinCarga.find(b => b.numInterno.toString() === busId);
                    if (bus) {
                        bus.estado = this.value;
                        // Actualizar el atributo data-estado para el color
                        this.setAttribute('data-estado', this.value);
                        // Guardar en localStorage
                        guardarEstadoBuses();
                    }
                });

                table.appendChild(row);
            }

            // Actualizar paginaci√≥n solo si no se est√° mostrando todo
            if (!showAllPendientes) {
                updatePagination('pendientes-pagination', filteredBusesSinCarga.length, currentPendientesPage, pendientesItemsPerPage, updatePendientesPage);
            } else {
                const paginacion = document.getElementById('pendientes-pagination');
                if (paginacion) paginacion.innerHTML = '';
            }

            console.log(`Tabla de pendientes actualizada: mostrando ${endIndex - startIndex} de ${filteredBusesSinCarga.length} buses`);
        }

        // Funci√≥n para actualizar la tabla de buses cargados
        function updateCargadosTable() {
            console.log("Actualizando tabla de buses cargados...");

            const table = document.getElementById('buses-cargados-body');
            if (!table) {
                console.warn("No se encontr√≥ la tabla de buses cargados");
                return;
            }

            table.innerHTML = '';

            if (filteredBusesCargados.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" class="text-center">No hay buses con carga o no se ha subido un archivo de carga.</td>';
                table.appendChild(row);

                const paginacion = document.getElementById('cargados-pagination');
                if (paginacion) paginacion.innerHTML = '';

                return;
            }

            const effectiveItemsPerPage = showAllCargados ? filteredBusesCargados.length : cargadosItemsPerPage;
            const startIndex = (currentCargadosPage - 1) * effectiveItemsPerPage;
            const endIndex = Math.min(startIndex + effectiveItemsPerPage, filteredBusesCargados.length);

            for (let i = startIndex; i < endIndex; i++) {
                const bus = filteredBusesCargados[i];
                const row = document.createElement('tr');

                row.innerHTML = `
            <td class="cell-highlight">${bus.numInterno}</td>
            <td>${bus.patente}</td>
            <td>${bus.fecha}</td>
            <td>${bus.hora}</td>
            <td>${bus.litros} L</td>
            <td>${bus.terminal}</td>
            <td>${bus.modelo}</td>
        `;

                table.appendChild(row);
            }

            // Actualizar paginaci√≥n solo si no se est√° mostrando todo
            if (!showAllCargados) {
                updatePagination('cargados-pagination', filteredBusesCargados.length, currentCargadosPage, cargadosItemsPerPage, updateCargadosPage);
            } else {
                const paginacion = document.getElementById('cargados-pagination');
                if (paginacion) paginacion.innerHTML = '';
            }

            console.log(`Tabla de cargados actualizada: mostrando ${endIndex - startIndex} de ${filteredBusesCargados.length} buses`);
        }

        // Funci√≥n para actualizar la paginaci√≥n
        function updatePagination(containerId, totalItems, currentPage, itemsPerPage, pageChangeFunction) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`No se encontr√≥ el contenedor de paginaci√≥n: ${containerId}`);
                return;
            }

            container.innerHTML = '';

            const totalPages = Math.ceil(totalItems / itemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            // Bot√≥n anterior
            const prevButton = document.createElement('button');
            prevButton.textContent = '¬´';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    pageChangeFunction(currentPage - 1);
                }
            });
            container.appendChild(prevButton);

            // Botones de p√°gina
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.addEventListener('click', () => pageChangeFunction(i));
                container.appendChild(pageButton);
            }

            // Bot√≥n siguiente
            const nextButton = document.createElement('button');
            nextButton.textContent = '¬ª';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    pageChangeFunction(currentPage + 1);
                }
            });
            container.appendChild(nextButton);
        }

        // Funciones para cambiar de p√°gina
        function updatePendientesPage(page) {
            currentPendientesPage = page;
            updatePendientesTable();
        }

        function updateCargadosPage(page) {
            currentCargadosPage = page;
            updateCargadosTable();
        }

        // Funci√≥n para formatear la fecha actual
        function formatCurrentDate() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return now.toLocaleDateString('es-CL', options);
        }

        // Funci√≥n para formatear la hora actual
        function formatCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('es-CL');
        }

        // Funci√≥n para exportar a Excel
        function exportToExcel() {
            console.log("Exportando a Excel...");

            // Crear un libro de trabajo
            const wb = XLSX.utils.book_new();

            // Crear hoja para buses pendientes
            const pendientesData = [
                ['N¬∞ Interno', 'Patente', 'Modelo', 'Tipo', 'Ubicaci√≥n', 'Estado', 'Estado Carga']
            ];

            filteredBusesSinCarga.forEach(bus => {
                pendientesData.push([
                    bus.numInterno,
                    bus.patente,
                    bus.modelo,
                    bus.tipo,
                    bus.ubicacion || '',
                    bus.estado || 'Operativo',
                    'Pendiente'
                ]);
            });

            const pendientesSheet = XLSX.utils.aoa_to_sheet(pendientesData);
            XLSX.utils.book_append_sheet(wb, pendientesSheet, 'Buses Pendientes');

            // Crear hoja para buses cargados
            const cargadosData = [
                ['N¬∞ Interno', 'Patente', 'Fecha', 'Hora', 'Litros', 'Terminal', 'Modelo']
            ];

            filteredBusesCargados.forEach(bus => {
                cargadosData.push([
                    bus.numInterno,
                    bus.patente,
                    bus.fecha,
                    bus.hora,
                    bus.litros,
                    bus.terminal,
                    bus.modelo
                ]);
            });

            const cargadosSheet = XLSX.utils.aoa_to_sheet(cargadosData);
            XLSX.utils.book_append_sheet(wb, cargadosSheet, 'Buses Cargados');

            // Crear hoja de resumen
            const resumenData = [
                ['M√©trica', 'Valor'],
                ['Total Buses', flotaCompleta.length],
                ['Buses con Carga', busesCargados.length],
                ['Buses Pendientes', busesSinCarga.length],
                ['Porcentaje Cargados', `${Math.round((busesCargados.length / flotaCompleta.length) * 100)}%`],
                ['Porcentaje Pendientes', `${Math.round((busesSinCarga.length / flotaCompleta.length) * 100)}%`]
            ];

            // A√±adir promedio de litros solo si hay buses cargados
            if (busesCargados.length > 0) {
                const totalLitros = busesCargados.reduce((sum, bus) => sum + parseInt(bus.litros || 0), 0);
                const promedioLitros = Math.round(totalLitros / busesCargados.length);
                resumenData.push(['Promedio de Litros', `${promedioLitros} L`]);
            } else {
                resumenData.push(['Promedio de Litros', '0 L']);
            }

            resumenData.push(
                ['Fecha de Reporte', formatCurrentDate()],
                ['Hora de Reporte', formatCurrentTime()]
            );

            const resumenSheet = XLSX.utils.aoa_to_sheet(resumenData);
            XLSX.utils.book_append_sheet(wb, resumenSheet, 'Resumen');

            // Exportar el libro
            const fileName = `Reporte_Combustible_LoEchevers_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            console.log(`Excel exportado como: ${fileName}`);
        }

        // Funci√≥n para exportar a PDF
        function exportToPDF() {
            console.log("Exportando a PDF...");

            // Verificar si jsPDF est√° disponible
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                console.error("Error: jsPDF no est√° disponible");
                alert("Error: No se puede generar el PDF porque la librer√≠a jsPDF no est√° disponible");
                return;
            }

            const { jsPDF } = window.jspdf;

            // Determinar qu√© tabla exportar basado en la pesta√±a activa
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) {
                console.error("Error: No se pudo encontrar la pesta√±a activa");
                alert("Error: No se pudo determinar qu√© tabla exportar");
                return;
            }

            const tabId = activeTab.getAttribute('data-tab');
            let tableContainer;
            let title;

            if (tabId === 'pendientes') {
                tableContainer = document.getElementById('pendientes-table-container');
                title = 'Buses Pendientes de Carga';
            } else if (tabId === 'cargados') {
                tableContainer = document.getElementById('cargados-table-container');
                title = 'Buses con Carga Completada';
            } else {
                alert('Seleccione la pesta√±a de pendientes o cargados para exportar a PDF');
                console.warn("Pesta√±a seleccionada no es una tabla:", tabId);
                return;
            }

            if (!tableContainer) {
                console.error(`Error: No se encontr√≥ el contenedor de la tabla para ${tabId}`);
                alert("Error: No se pudo encontrar la tabla para exportar");
                return;
            }

            // Crear copia de la tabla para exportaci√≥n
            const exportTable = tableContainer.cloneNode(true);
            exportTable.style.width = '100%';

            // Crear un contenedor temporal para la tabla a exportar
            const tempDiv = document.createElement('div');
            tempDiv.classList.add('printable-table');
            tempDiv.style.width = '100%';
            tempDiv.style.padding = '20px';
            tempDiv.style.backgroundColor = 'white';

            // A√±adir t√≠tulo
            const titleEl = document.createElement('h2');
            titleEl.textContent = title;
            titleEl.style.textAlign = 'center';
            titleEl.style.marginBottom = '20px';
            titleEl.style.color = '#4b86b4';
            tempDiv.appendChild(titleEl);

            // A√±adir fecha
            const dateEl = document.createElement('p');
            dateEl.textContent = `Fecha: ${formatCurrentDate()} - ${formatCurrentTime()}`;
            dateEl.style.textAlign = 'center';
            dateEl.style.marginBottom = '20px';
            tempDiv.appendChild(dateEl);

            // A√±adir la tabla
            tempDiv.appendChild(exportTable);

            // A√±adir al documento temporalmente
            document.body.appendChild(tempDiv);

            // Generar PDF usando html2canvas
            if (typeof html2canvas === 'undefined') {
                console.error("Error: html2canvas no est√° disponible");
                alert("Error: No se puede generar el PDF porque la librer√≠a html2canvas no est√° disponible");
                document.body.removeChild(tempDiv);
                return;
            }

            // Generar PDF
            html2canvas(tempDiv, {
                scale: 2, // Mayor calidad
                useCORS: true,
                logging: false
            }).then(canvas => {
                // Eliminar el contenedor temporal
                document.body.removeChild(tempDiv);

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 30;

                // A√±adir logo o encabezado
                pdf.setFontSize(18);
                pdf.setTextColor(75, 134, 180);
                pdf.text('Sistema de An√°lisis de Combustible', pdfWidth / 2, 15, { align: 'center' });

                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);

                const fileName = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                console.log(`PDF exportado como: ${fileName}`);
            }).catch(error => {
                console.error("Error al generar el PDF:", error);
                alert("Error al generar el PDF: " + error.message);

                // Asegurar que eliminamos el contenedor temporal en caso de error
                if (document.body.contains(tempDiv)) {
                    document.body.removeChild(tempDiv);
                }
            });
        }

        // Funci√≥n para imprimir el reporte
        function printReport() {
            window.print();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Documento cargado, inicializando aplicaci√≥n...");

            try {
                // Inicializar la flota
                inicializarFlota();

                // Configurar tabs
                const tabs = document.querySelectorAll('.tab');
                if (tabs) {
                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            const tabId = tab.getAttribute('data-tab');

                            // Actualizar clases active
                            tabs.forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');

                            document.querySelectorAll('.tab-content').forEach(content => {
                                content.classList.remove('active');
                            });

                            const tabContent = document.getElementById(`${tabId}-tab`);
                            if (tabContent) {
                                tabContent.classList.add('active');
                            } else {
                                console.warn(`Tab content not found: ${tabId}-tab`);
                            }
                        });
                    });
                }

                // Configurar b√∫squeda
                const searchButton = document.getElementById('search-button');
                if (searchButton) {
                    searchButton.addEventListener('click', aplicarFiltros);
                }

                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.addEventListener('keyup', e => {
                        if (e.key === 'Enter') {
                            aplicarFiltros();
                        }
                    });
                }

                // Configurar filtros
                const filterModelo = document.getElementById('filter-modelo');
                if (filterModelo) {
                    filterModelo.addEventListener('change', aplicarFiltros);
                }

                const filterTipo = document.getElementById('filter-tipo');
                if (filterTipo) {
                    filterTipo.addEventListener('change', aplicarFiltros);
                }

                const filterTerminal = document.getElementById('filter-terminal');
                if (filterTerminal) {
                    filterTerminal.addEventListener('change', aplicarFiltros);
                }

                // Configurar opciones de paginaci√≥n
                const pendientesPerPage = document.getElementById('pendientes-per-page');
                if (pendientesPerPage) {
                    pendientesPerPage.addEventListener('change', (e) => {
                        pendientesItemsPerPage = parseInt(e.target.value);
                        currentPendientesPage = 1;
                        showAllPendientes = false;
                        const showAllBtn = document.getElementById('show-all-pendientes');
                        if (showAllBtn) showAllBtn.classList.remove('active');
                        updatePendientesTable();
                    });
                }

                const cargadosPerPage = document.getElementById('cargados-per-page');
                if (cargadosPerPage) {
                    cargadosPerPage.addEventListener('change', (e) => {
                        cargadosItemsPerPage = parseInt(e.target.value);
                        currentCargadosPage = 1;
                        showAllCargados = false;
                        const showAllBtn = document.getElementById('show-all-cargados');
                        if (showAllBtn) showAllBtn.classList.remove('active');
                        updateCargadosTable();
                    });
                }

                // Configurar botones "Mostrar todos"
                const showAllPendientesBtn = document.getElementById('show-all-pendientes');
                if (showAllPendientesBtn) {
                    showAllPendientesBtn.addEventListener('click', () => {
                        showAllPendientes = !showAllPendientes;
                        showAllPendientesBtn.classList.toggle('active', showAllPendientes);
                        currentPendientesPage = 1;
                        updatePendientesTable();
                    });
                }

                const showAllCargadosBtn = document.getElementById('show-all-cargados');
                if (showAllCargadosBtn) {
                    showAllCargadosBtn.addEventListener('click', () => {
                        showAllCargados = !showAllCargados;
                        showAllCargadosBtn.classList.toggle('active', showAllCargados);
                        currentCargadosPage = 1;
                        updateCargadosTable();
                    });
                }

                // Configurar carga de archivos
                const fileInput = document.getElementById('file-input');
                const fileUploadContainer = document.getElementById('file-upload-container');
                const fileName = document.getElementById('file-name');

                if (fileInput && fileUploadContainer) {
                    console.log("Configurando carga de archivos...");

                    fileInput.addEventListener('change', function (e) {
                        console.log("Archivo seleccionado:", e.target.files);
                        if (this.files && this.files[0]) {
                            const file = this.files[0];
                            if (fileName) {
                                fileName.textContent = file.name;
                                fileName.style.display = 'block';
                            }

                            // Procesar el archivo
                            procesarArchivoCarga(file);
                        }
                    });

                    // Configurar drag and drop
                    fileUploadContainer.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    });

                    fileUploadContainer.addEventListener('dragleave', function () {
                        this.classList.remove('drag-over');
                    });

                    fileUploadContainer.addEventListener('drop', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.remove('drag-over');

                        console.log("Archivo arrastrado:", e.dataTransfer.files);

                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            const file = e.dataTransfer.files[0];

                            // Asignar el archivo al input para mantener la consistencia
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;

                            if (fileName) {
                                fileName.textContent = file.name;
                                fileName.style.display = 'block';
                            }

                            // Procesar el archivo
                            procesarArchivoCarga(file);
                        }
                    });
                } else {
                    console.warn("No se encontraron los elementos para la carga de archivos");
                }

                // Configurar actualizaci√≥n de datos
                const refreshButton = document.getElementById('refresh-data');
                if (refreshButton) {
                    refreshButton.addEventListener('click', () => {
                        const loader = document.getElementById('loader');
                        if (loader) loader.style.display = 'block';

                        // Simular una carga
                        setTimeout(() => {
                            actualizarBusesSinCarga();
                            actualizarGraficos();
                            updateDashboard();
                            if (loader) loader.style.display = 'none';
                        }, 800);
                    });
                }

                // Configurar exportaci√≥n a Excel
                const excelButton = document.getElementById('download-excel');
                if (excelButton) {
                    excelButton.addEventListener('click', exportToExcel);
                }

                // Configurar exportaci√≥n a PDF
                const pdfButton = document.getElementById('download-pdf');
                if (pdfButton) {
                    pdfButton.addEventListener('click', exportToPDF);
                }

                // Configurar impresi√≥n
                const printButton = document.getElementById('print-report');
                if (printButton) {
                    printButton.addEventListener('click', printReport);
                }

                // Actualizar fecha y hora inicial
                const currentDateElement = document.getElementById('current-date');
                if (currentDateElement) {
                    currentDateElement.textContent = formatCurrentDate();
                }

                const lastUpdateElement = document.getElementById('last-update-time');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = formatCurrentTime();
                }

                console.log("Aplicaci√≥n inicializada correctamente");

            } catch (error) {
                console.error("Error al inicializar la aplicaci√≥n:", error);
                alert("Error al inicializar la aplicaci√≥n: " + error.message);
            }
        });

        // Funci√≥n para guardar el estado de los buses en localStorage
        function guardarEstadoBuses() {
            const estadoBuses = busesSinCarga.map(bus => ({
                numInterno: bus.numInterno,
                ubicacion: bus.ubicacion || '',
                estado: bus.estado || 'Operativo'
            }));
            localStorage.setItem('estadoBuses', JSON.stringify(estadoBuses));
        }

        // Funci√≥n para cargar el estado de los buses desde localStorage
        function cargarEstadoBuses() {
            const estadoGuardado = localStorage.getItem('estadoBuses');
            if (estadoGuardado) {
                const estadoBuses = JSON.parse(estadoGuardado);
                estadoBuses.forEach(estado => {
                    const bus = busesSinCarga.find(b => b.numInterno.toString() === estado.numInterno.toString());
                    if (bus) {
                        bus.ubicacion = estado.ubicacion;
                        bus.estado = estado.estado;
                    }
                });
            }
        }
    </script>


</body>

</html>
